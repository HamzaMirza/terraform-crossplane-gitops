name: GitHub CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch: #for manual triggering
    inputs:
      terraform:
        description: "Run Terraform Apply"
        required: true
        type: string

jobs:
  detect-changes:
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 3

      - name: Determine change folders
        id: detect-changes
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            # shellcheck disable=SC2086
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            # shellcheck disable=SC2086
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          else
            # shellcheck disable=SC2086
            BASE_SHA="${{ github.event.before }}"
            # shellcheck disable=SC2086
            HEAD_SHA="${{ github.event.after }}"
          fi
          echo "Comparing \"${BASE_SHA}\" to \"${HEAD_SHA}\""

          if git diff --name-only "${BASE_SHA}" "${HEAD_SHA}" | grep -q "terraform/"; then
            echo "Changes detected in terraform/"
            echo "terraform=true" >> "$GITHUB_OUTPUT"
          else
            echo "No changes detected in terraform/"
            echo "terraform=false" >> "$GITHUB_OUTPUT"
          fi

          if git diff --name-only "${BASE_SHA}" "${HEAD_SHA}" | grep -q "crossplane/"; then
            echo "Changes detected in crossplane/"
            echo "crossplane=true" >> "$GITHUB_OUTPUT"
          else
            echo "No changes detected in crossplane/"
            echo "crossplane=false" >> "$GITHUB_OUTPUT"
          fi
  terraform-plan:
    runs-on: self-hosted
    needs: detect-changes
    env:
      TF_HTTP_PASSWORD: ${{ secrets.TF_HTTP_PASSWORD }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 3

      - name: Verify Terraform is installed
        run: |
          if ! command -v terraform &> /dev/null; then
            echo "Error: Terraform is not installed on this self-hosted runner"
            echo "Please install Terraform: https://developer.hashicorp.com/terraform/downloads"
            exit 1
          fi
          terraform --version
      - name: Verify Terragrunt is installed
        run: |
          if ! command -v terragrunt &> /dev/null; then
            echo "Error: Terragrunt is not installed on this self-hosted runner"
            echo "Please install Terragrunt: https://terragrunt.gruntwork.io/docs/getting-started/install/"
            exit 1
          fi
          terragrunt --version

      # - name: Terragrunt format check on terraform/ 
      #   run: |
      #     terragrunt run-all fmt --check -recursive --terragrunt-working-dir terraform/ || (echo "Terraform files are not formatted correctly" && exit 1)

      - name: Terragrunt validate on terraform/
        run: |
          terragrunt run-all validate --terragrunt-working-dir  terraform/ || (echo "Terraform files are not valid" && exit 1)

      - name: Terragrunt plan on terraform/
        run: |
          terragrunt run-all plan  --terragrunt-non-interactive || (echo "Terraform files are not planned correctly" && exit 1)
  terraform-apply:
    runs-on: self-hosted
    needs: terraform-plan
    if: (github.event_name == 'push' && github.ref == 'refs/heads/main') || (github.event_name == 'workflow_dispatch' && github.event.inputs.terraform == 'true')
    env:
      TF_HTTP_PASSWORD: ${{ secrets.TF_HTTP_PASSWORD }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 3

      - name: Verify Terraform is installed
        run: |
          if ! command -v terraform &> /dev/null; then
            echo "Error: Terraform is not installed on this self-hosted runner"
            echo "Please install Terraform: https://developer.hashicorp.com/terraform/downloads"
            exit 1
          fi
          terraform --version
      - name: Verify Terragrunt is installed
        run: |
          if ! command -v terragrunt &> /dev/null; then
            echo "Error: Terragrunt is not installed on this self-hosted runner"
            echo "Please install Terragrunt: https://terragrunt.gruntwork.io/docs/getting-started/install/"
            exit 1
          fi
          terragrunt --version

      - name: Terragrunt apply on terraform/
        run: |
          echo "Applying Terraform files"
          terragrunt run-all apply --terragrunt-filter-affected --terragrunt-non-interactive|| (echo "Terraform files are not applied correctly" && exit 1)

      - name: Terraform output
        run: |
          echo "Terraform output"
          terragrunt run-all output --terragrunt-working-dir terraform/ || (echo "Terraform output is not correct" && exit 1)